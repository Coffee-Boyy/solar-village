- name: Create Garage directories
  file: { path: /opt/garage, state: directory }

- name: Drop Garage compose
  template:
    src: docker-compose.yml.j2
    dest: /opt/garage/docker-compose.yml

- name: Drop Garage config
  template:
    src: garage.toml.j2
    dest: /opt/garage/garage.toml

- name: Up Garage container
  community.docker.docker_compose_v2:
    project_src: /opt/garage
    state: present

- name: Wait for Garage to be ready
  wait_for:
    host: "{{ wg_ip }}"
    port: 3903
    timeout: 300

- name: Set garage node 0 hostname
  set_fact:
    garage_node0_host: "{{ groups['garage_all'][0] }}"

- name: Get node 0 node ID
  shell: docker exec garage /garage node id -q
  register: garage_node0_id
  when: inventory_hostname == garage_node0_host
  changed_when: false

- name: Set node 0 ID fact for all hosts
  set_fact:
    garage_node0_id_full: "{{ hostvars[garage_node0_host]['garage_node0_id']['stdout'] }}"
  when: hostvars[garage_node0_host]['garage_node0_id'] is defined

- name: Connect non-node-0 nodes to node 0
  shell: docker exec garage /garage node connect "{{ garage_node0_id_full }}"
  when: inventory_hostname != garage_node0_host and garage_node0_id_full is defined

- name: Get current node ID
  shell: docker exec garage /garage node id -q
  register: garage_current_node_id
  changed_when: false

- name: Configure node with storage capacity and zone
  shell: |
    docker exec garage /garage layout assign \
      -c {{ garage_storage_capacity }} \
      -z {{ garage_zone }} \
      {{ garage_current_node_id.stdout.split('@')[0] }}
  run_once: false
  changed_when: true

- name: Apply layout configuration
  shell: docker exec garage /garage layout apply --version 1
  when: inventory_hostname == garage_node0_host
  changed_when: true
  ignore_errors: true
