- name: "Create mysql app dir"
  file: { path: /opt/mysql, state: directory }

- name: "Ensure subdirs exist"
  file:
    path: "{{ item }}"
    state: directory
    owner: 999
    group: 999
    mode: "0755"
  loop:
    - /opt/mysql/certs

# Check if cluster already exists (determine if bootstrap is needed)
- name: "Try to read current cluster size (may fail on first run)"
  shell: |
    docker exec mysql mysql -uroot -p'{{ mysql_root_password }}' -NBe "SHOW STATUS LIKE 'wsrep_cluster_status'\G" 2>/dev/null | grep Primary
  register: pxc_cluster_size_probe
  changed_when: false
  failed_when: false
  ignore_errors: true

- name: "Determine if bootstrap is needed"
  set_fact:
    pxc_needs_bootstrap: "{{ inventory_hostname == groups['mysql_gr'][0] and pxc_cluster_size_probe.rc != 0 }}"

- name: "Determine if this is bootstrap node"
  set_fact:
    is_bootstrap_node: "{{ inventory_hostname == groups['mysql_gr'][0] }}"

- name: "Determine if this is a follower node"
  set_fact:
    is_follower_node: "{{ inventory_hostname != groups['mysql_gr'][0] }}"

# === Phase 1: Bootstrap Node Initialization ===
- name: "Render docker-compose for bootstrap node"
  when: is_bootstrap_node and pxc_needs_bootstrap
  block:
    - name: "Render docker-compose (Percona PXC) - Bootstrap"
      template:
        src: docker-compose.yml.j2
        dest: /opt/mysql/docker-compose.yml
      vars:
        pxc_bootstrap_flag: true
        pxc_seed_ip: "{{ hostvars[groups['mysql_gr'][0]].wg_ip }}"

    - name: "Render mysql (pxc) config"
      template:
        src: mysql.conf.j2
        dest: /opt/mysql/mysql.conf

    - name: "Start bootstrap node"
      community.docker.docker_compose_v2:
        project_src: /opt/mysql
        state: present
        pull: always

    - name: "Wait for MySQL to be ready (bootstrap node)"
      shell: docker exec mysql sh -c "mysqladmin ping -uroot -p'{{ mysql_root_password }}'"
      register: mysql_ready_boot
      retries: 60
      until: mysql_ready_boot.rc == 0
      changed_when: false

    - name: "Wait for cluster to be fully initialized"
      shell: docker exec mysql sh -c "mysql -uroot -p'{{ mysql_root_password }}' -NBe \"SHOW STATUS LIKE 'wsrep_cluster_status'\" 2>/dev/null | grep -i Primary || echo 'NotReady'"
      register: cluster_status
      retries: 30
      until: "'Primary' in cluster_status.stdout"
      changed_when: false

    - name: "Wait for certificates to be auto-generated by MySQL"
      shell: docker exec mysql sh -c "test -f /var/lib/mysql/ca.pem && test -f /var/lib/mysql/server-cert.pem && test -f /var/lib/mysql/server-key.pem && echo 'ready' || echo 'waiting'"
      register: cert_check
      retries: 30
      until: "'ready' in cert_check.stdout"
      changed_when: false

    - name: "Copy certificates from container to host (bootstrap node)"
      shell: |
        docker cp mysql:/var/lib/mysql/ca.pem /opt/mysql/certs/ca.pem
        docker cp mysql:/var/lib/mysql/server-cert.pem /opt/mysql/certs/server-cert.pem
        docker cp mysql:/var/lib/mysql/server-key.pem /opt/mysql/certs/server-key.pem
        docker cp mysql:/var/lib/mysql/client-cert.pem /opt/mysql/certs/client-cert.pem
        docker cp mysql:/var/lib/mysql/client-key.pem /opt/mysql/certs/client-key.pem

    - name: "Set proper permissions on certificates (bootstrap node)"
      file:
        path: "{{ item }}"
        owner: 999
        group: 999
        mode: "{{ '0600' if 'key' in item else '0644' }}"
      loop:
        - /opt/mysql/certs/ca.pem
        - /opt/mysql/certs/server-cert.pem
        - /opt/mysql/certs/server-key.pem
        - /opt/mysql/certs/client-cert.pem
        - /opt/mysql/certs/client-key.pem

    - name: "Re-render docker-compose without bootstrap flag"
      template:
        src: docker-compose.yml.j2
        dest: /opt/mysql/docker-compose.yml
      vars:
        pxc_bootstrap_flag: false
        pxc_seed_ip: "{{ hostvars[groups['mysql_gr'][0]].wg_ip }}"

    - name: "Apply updated compose (remove bootstrap flag)"
      community.docker.docker_compose_v2:
        project_src: /opt/mysql
        state: present

- name: "Check if bootstrap node certificates exist (for re-run scenarios)"
  when: is_bootstrap_node
  block:
    - name: "Check if certificates exist on bootstrap node"
      stat:
        path: "/opt/mysql/certs/ca.pem"
      register: certs_on_bootstrap

    - name: "Copy certificates from container if not already on host"
      shell: |
        docker cp mysql:/var/lib/mysql/ca.pem /opt/mysql/certs/ca.pem
        docker cp mysql:/var/lib/mysql/server-cert.pem /opt/mysql/certs/server-cert.pem
        docker cp mysql:/var/lib/mysql/server-key.pem /opt/mysql/certs/server-key.pem
        docker cp mysql:/var/lib/mysql/client-cert.pem /opt/mysql/certs/client-cert.pem
        docker cp mysql:/var/lib/mysql/client-key.pem /opt/mysql/certs/client-key.pem

    - name: "Set proper permissions on certificates (re-run scenario)"
      file:
        path: "{{ item }}"
        owner: 999
        group: 999
        mode: "{{ '0600' if 'key' in item else '0644' }}"
      loop:
        - /opt/mysql/certs/ca.pem
        - /opt/mysql/certs/server-cert.pem
        - /opt/mysql/certs/server-key.pem
        - /opt/mysql/certs/client-cert.pem
        - /opt/mysql/certs/client-key.pem

- name: "Fetch certificates from bootstrap node to controller"
  when: is_bootstrap_node
  fetch:
    src: "/opt/mysql/certs/{{ item }}"
    dest: "generated-certs/{{ item }}"
    flat: yes
  loop:
    - ca.pem
    - server-cert.pem
    - server-key.pem
    - client-cert.pem
    - client-key.pem

# Wait for bootstrap node to be ready before starting follower nodes
- name: "Wait for bootstrap node to be ready (follower nodes only)"
  when: is_follower_node
  block:
    - name: "Wait for bootstrap node MySQL to be ready"
      wait_for:
        host: "{{ hostvars[groups['mysql_gr'][0]].wg_ip }}"
        port: 3306
        timeout: 300
      run_once: true

    - name: "Wait for certificates to be available on controller"
      wait_for:
        path: "generated-certs/ca.pem"
        timeout: 300
      delegate_to: localhost
      become: false
      run_once: true

# === Phase 2: Certificate Distribution to Follower Nodes ===
- name: "Check if certificates already exist on follower node"
  when: is_follower_node
  stat:
    path: "/opt/mysql/certs/ca.pem"
  register: certs_on_follower

- name: "Distribute certificates to follower nodes"
  when: is_follower_node
  copy:
    src: "generated-certs/{{ item }}"
    dest: "/opt/mysql/certs/{{ item }}"
    owner: 999
    group: 999
    mode: "{{ '0600' if item.endswith('.key') else '0644' }}"
  loop:
    - ca.pem
    - server-cert.pem
    - server-key.pem
    - client-cert.pem
    - client-key.pem

# === Phase 3: Follower Nodes Initialization ===
- name: "Render docker-compose for follower nodes"
  when: is_follower_node
  block:
    - name: "Render docker-compose (Percona PXC) - Follower"
      template:
        src: docker-compose.yml.j2
        dest: /opt/mysql/docker-compose.yml
      vars:
        pxc_bootstrap_flag: false
        pxc_seed_ip: "{{ hostvars[groups['mysql_gr'][0]].wg_ip }}"

    - name: "Render mysql (pxc) config"
      template:
        src: mysql.conf.j2
        dest: /opt/mysql/mysql.conf

    - name: "Start follower node"
      community.docker.docker_compose_v2:
        project_src: /opt/mysql
        state: present
        pull: always

    - name: "Wait for MySQL to be ready (follower node)"
      shell: docker exec mysql sh -c "mysqladmin ping -uroot -p'{{ mysql_root_password }}'"
      register: mysql_ready_follower
      retries: 60
      until: mysql_ready_follower.rc == 0
      changed_when: false

    - name: "Wait for follower to join cluster"
      shell: docker exec mysql sh -c "mysql -uroot -p'{{ mysql_root_password }}' -NBe \"SHOW STATUS LIKE 'wsrep_local_state_comment'\" 2>/dev/null | tail -1"
      register: local_state
      retries: 30
      until: "'Synced' in local_state.stdout"
      changed_when: false

# === Final: Wait for all nodes and report status ===
- name: "Wait for MySQL to be ready (all nodes)"
  shell: docker exec mysql sh -c "mysqladmin ping -uroot -p'{{ mysql_root_password }}'"
  register: mysql_ready
  retries: 30
  until: mysql_ready.rc == 0
  changed_when: false

- name: "Report cluster size and status"
  shell: |
    docker exec mysql mysql -uroot -p'{{ mysql_root_password }}' -NBe "SHOW STATUS LIKE 'wsrep_cluster_size'; SHOW STATUS LIKE 'wsrep_cluster_status';"
  register: wsrep_status
  changed_when: false
  failed_when: false
