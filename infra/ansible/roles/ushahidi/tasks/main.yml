- name: Ensure ushahidi dir
  file: { path: /opt/ushahidi, state: directory }

- name: Create PostgreSQL database for Ushahidi
  shell: |
    docker exec postgres psql -U postgres -c "CREATE DATABASE {{ postgres_db }};" 2>/dev/null || echo "Database may already exist"
  delegate_to: "{{ groups['postgres'][0] }}"
  run_once: true
  changed_when: false
  environment:
    PGPASSWORD: "{{ postgres_superuser_password }}"

- name: Create PostgreSQL user for Ushahidi
  shell: |
    docker exec postgres psql -U postgres -c "CREATE USER {{ postgres_app_user }} WITH PASSWORD '{{ postgres_app_password }}';" 2>/dev/null || echo "User may already exist"
  delegate_to: "{{ groups['postgres'][0] }}"
  run_once: true
  changed_when: false
  environment:
    PGPASSWORD: "{{ postgres_superuser_password }}"

- name: Grant privileges to PostgreSQL user on database
  shell: |
    docker exec postgres psql -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE {{ postgres_db }} TO {{ postgres_app_user }};"
  delegate_to: "{{ groups['postgres'][0] }}"
  run_once: true
  changed_when: false
  environment:
    PGPASSWORD: "{{ postgres_superuser_password }}"

- name: Check if Garage bucket exists
  shell: docker exec garage /garage bucket info {{ garage_bucket_name }}
  register: garage_bucket_check
  run_once: true
  changed_when: false
  failed_when: false

- name: Create Garage S3 bucket
  shell: docker exec garage /garage bucket create {{ garage_bucket_name }}
  run_once: true
  when: garage_bucket_check.rc != 0

- name: Render Ushahidi compose file
  template:
    src: docker-compose.yml.j2
    dest: /opt/ushahidi/docker-compose.yml

- name: Start Ushahidi container
  community.docker.docker_compose_v2:
    project_src: /opt/ushahidi
    state: present
