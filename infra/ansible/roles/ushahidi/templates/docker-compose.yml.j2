services:
  redis:
    image: redis:7.2-alpine
  ushahidi:
    image: {{ ushahidi_image }}
    container_name: ushahidi
    restart: always
    environment:
      APP_KEY: "SomeRandomKey!!!SomeRandomKey!!!"
      BASE_URL: "{{ ushahidi_site_url }}"
      ENABLE_NGINX: "true"
      ENABLE_PLATFORM_TASKS: "false"
      RUN_PLATFORM_MIGRATIONS: "{{ 'true' if inventory_hostname == groups['app_servers'][0] else 'false' }}"

      REDIS_HOST: redis
      CACHE_DRIVER: redis
      QUEUE_DRIVER: redis

      DB_CONNECTION: "pgsql"
      DB_HOST: {{ postgres_vip }}
      DB_PORT: 5432
      DB_DATABASE: "{{ postgres_db }}"
      DB_USERNAME: "{{ postgres_app_user }}"
      DB_PASSWORD: "{{ postgres_app_password }}"

      S3_BUCKET: "{{ garage_bucket_name }}"
      S3_ENDPOINT: "http://{{ wg_ip }}:3900"
      S3_ACCESS_KEY: "{{ garage_access_key_id }}"
      S3_SECRET_KEY: "{{ garage_secret_access_key }}"
      S3_REGION: "{{ garage_s3_region }}"
      S3_USE_PATH_STYLE_ENDPOINT: "true"
    ports:
      - "9080:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
