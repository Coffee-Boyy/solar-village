- name: "Create mysql app dir"
  file: { path: /opt/mysql, state: directory }

- name: "Render docker-compose"
  template:
    src: docker-compose.yml.j2
    dest: /opt/mysql/docker-compose.yml

- name: "Render mysql router config"
  template:
    src: router.conf.j2
    dest: /opt/mysql/router.conf

- name: "Render mysql config"
  template:
    src: mysql.conf.j2
    dest: /opt/mysql/mysql.conf

- name: "Up MySQL and Router"
  community.docker.docker_compose_v2:
    project_src: /opt/mysql
    state: present

- name: "Wait for MySQL to be ready"
  shell: |
    docker exec mysql sh -c "mysqladmin ping -h{{ wg_ip }} -uroot -p'{{ mysql_root_password }}'"
  register: mysql_ready
  retries: 30
  delay: 2
  until: mysql_ready.rc == 0
  changed_when: false

# Bootstrap GR on first node only
- name: "Bootstrap GR (first primary only)"
  when: inventory_hostname == groups['mysql_gr'][0]
  shell: |
    docker exec mysql mysql -uroot -p'{{ mysql_root_password }}' -e "
      SET SQL_LOG_BIN=0;
      SET GLOBAL group_replication_bootstrap_group=ON;
      CREATE USER IF NOT EXISTS '{{ mysql_gr_user }}'@'%' IDENTIFIED BY '{{ mysql_gr_password }}';
      GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO '{{ mysql_gr_user }}'@'%';
      FLUSH PRIVILEGES;
      SET SQL_LOG_BIN=1;
      CHANGE REPLICATION SOURCE TO SOURCE_USER='{{ mysql_gr_user }}', SOURCE_PASSWORD='{{ mysql_gr_password }}' FOR CHANNEL 'group_replication_recovery';
      START GROUP_REPLICATION;
      SET GLOBAL group_replication_bootstrap_group=OFF;
    "

# Join other primaries
- name: "Join GR (other primaries)"
  when: inventory_hostname != groups['mysql_gr'][0] and ('mysql_gr' in group_names)
  shell: |
    docker exec mysql mysql -uroot -p'{{ mysql_root_password }}' -e "
      SET SQL_LOG_BIN=0;
      CREATE USER IF NOT EXISTS '{{ mysql_gr_user }}'@'%' IDENTIFIED BY '{{ mysql_gr_password }}';
      GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO '{{ mysql_gr_user }}'@'%';
      FLUSH PRIVILEGES;
      SET SQL_LOG_BIN=1;
      CHANGE REPLICATION SOURCE TO SOURCE_USER='{{ mysql_gr_user }}', SOURCE_PASSWORD='{{ mysql_gr_password }}' FOR CHANNEL 'group_replication_recovery';
      START GROUP_REPLICATION;
    "
